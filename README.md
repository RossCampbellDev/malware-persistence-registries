# Malware Persistence
## run/runonce registry keys
`HKEY_CURRENT_USER` or `HKEY_LOCAL_MACHINE` -> software\\Microsoft\\Windows\\CurrentVersion\\

so there are two registries.  Run and RunOnce.  they can contain paths to executables and options for those programs

within my Run registry there are three keys that represent 3 programs that will be run at startup

## BootExecute key
quite similar to run and runonce.

`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`
`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify`
`HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell`

Shell, for example, runs on the Explorer.exe process.  If we add a key here it will be run by that process?  these will be run at the Winlogon step in boot

## Startup
`CurrentVersion\Explorer\Shell Folders`

after system boots in, these are then loaded.  look in the keys for malicious/suspicious files

## File Association Keys
'whenever you want to execute something associated to any kind of files, there are keys that are used to specify actiosn when files are opened'

eg if i am opening notepad, some other action is also taken

`HKEY_LOCAL_MACHINE\SOFTWARE\Classes` -> these are the file association keys.

create a key and add the path to an executable and this will then start up

## Services
find a service in services.msc and so on -> find the recovery options, and set 'run a program' and then point to the exe file.

this will then be run whenever the original program exits improperly, eg crashes.  the recovery program will then be hidden in the back end.

Attacker may be trying to force the original process to crash out in order to get their payload to run

## Shortcut Hijacking
basically just adding to the 'target' field of a windows shortcut.

## Autoruns being hidden
check using Autoruns from sysinternals

adding keys in \\WindowsNT\\CurrentVersion\\SilentProcessExit\\process.exe can enable us to silently run malicious processes when an application is terminated.  there are a couple of keys to add

a process started in this way will not show in process hacker, procmon etc unless you search specifically for the name of the malicious exe

## winesap plugin for volatility
looks for "Autostart Extensibility Points" - or AESP

`volatility.py --plugins /vola-plugins -f mem.vmem --profile=Win winesap --match`

load the plugin and run it against our capture mem.vmem, looking for 
